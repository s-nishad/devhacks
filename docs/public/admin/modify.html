<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secret Zone</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { background: #222; color: #fff; padding: 20px; text-align: center; }
    h1 { margin: 0; font-size: 1.8em; }
    main { display: flex; height: calc(100vh - 80px); }
    #editor, #preview { width: 50%; padding: 20px; overflow-y: auto; }
    #editor { background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
    #editor input, #editor select { padding: 10px; font-size: 1em; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
    #editor textarea { flex: 1; padding: 10px; font-family: monospace; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; resize: none; }
    #editor button { padding: 10px; margin-top: 10px; background: #28a745; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    #editor button:hover { background: #218838; }
    #preview { background: #fafafa; border-left: 1px solid #ccc; }
    #status { margin-top: 10px; font-weight: bold; }
    pre { background: #eee; padding: 10px; overflow-x: auto; }
    code { font-family: monospace; }
  </style>
</head>
<body>
<header>
  <h1>Blog Admin - Modify Posts</h1>
</header>
<main>
  <div id="editor">
    <select id="folderSelect">
      <option value="blog">Blog</option>
      <option value="hacks">Hacks</option>
    </select>
    <select id="fileSelect">
      <option value="">-- New Post --</option>
    </select>
    <input type="text" id="title" placeholder="Post Title" required />
    <textarea id="content" placeholder="Write your markdown here..." required></textarea>
    <button id="uploadBtn">Save Post</button>
    <p id="status"></p>
  </div>
  <div id="preview">
    <h2>Live Preview</h2>
    <div id="previewContent"></div>
  </div>
</main>

<script>
const token = prompt("Enter your GitHub Personal Access Token:");
const owner = 's-nishad';
const repo = 'devhacks';

const folderSelect = document.getElementById('folderSelect');
const fileSelect = document.getElementById('fileSelect');
const titleInput = document.getElementById('title');
const contentInput = document.getElementById('content');
const previewDiv = document.getElementById('previewContent');
const statusDiv = document.getElementById('status');
const uploadBtn = document.getElementById('uploadBtn');

// Live preview
contentInput.addEventListener('input', () => {
  previewDiv.innerHTML = marked.parse(contentInput.value);
});

// Capitalize words
const capitalizeWords = str =>
  str.split(/[-_ ]+/).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

// List markdown files in folder
async function listFiles(folder) {
  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folder}`, {
      headers: { Authorization: `token ${token}` }
    });

    if (!res.ok) {
      const err = await res.json();
      console.error('GitHub API Error:', err.message);
      statusDiv.textContent = `❌ Error fetching files: ${err.message}`;
      return [];
    }

    const files = await res.json();
    if (!Array.isArray(files)) {
      console.error('Unexpected GitHub response:', files);
      statusDiv.textContent = '❌ Unexpected response from GitHub API';
      return [];
    }

    return files.filter(f => f.type === 'file' && f.name.endsWith('.md') && f.name.toLowerCase() !== 'index.md');
  } catch (err) {
    console.error(err);
    statusDiv.textContent = `❌ Network error: ${err.message}`;
    return [];
  }
}

// Populate file dropdown
async function populateFiles() {
  const folder = folderSelect.value;
  fileSelect.innerHTML = '<option value="">-- New Post --</option>';
  const files = await listFiles(folder);

  if (files.length === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = '-- No posts found, create new --';
    fileSelect.appendChild(option);
  } else {
    files.forEach(f => {
      const option = document.createElement('option');
      option.value = f.name;
      option.textContent = capitalizeWords(f.name.replace('.md','').replace(/-/g,' '));
      fileSelect.appendChild(option);
    });
  }
}

// Load selected file
fileSelect.addEventListener('change', async () => {
  const folder = folderSelect.value;
  const filename = fileSelect.value;
  if (!filename) {
    titleInput.value = '';
    contentInput.value = '';
    previewDiv.innerHTML = '';
    delete contentInput.dataset.sha;
    return;
  }
  const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folder}/${filename}`, {
    headers: { Authorization: `token ${token}` }
  });
  const data = await res.json();
  const content = atob(data.content);
  titleInput.value = filename.replace(/\.md$/, '').replace(/-/g, ' ');
  contentInput.value = content;
  previewDiv.innerHTML = marked.parse(content);
  contentInput.dataset.sha = data.sha; // save SHA for updates
});

// Folder change refreshes file list
folderSelect.addEventListener('change', populateFiles);

// Upload or update post
uploadBtn.addEventListener('click', async () => {
  const folder = folderSelect.value;
  const title = titleInput.value.trim();
  const content = contentInput.value;
  if (!title || !content) {
    statusDiv.textContent = '❌ Title and content are required!';
    return;
  }
  const filename = title.toLowerCase().replace(/\s+/g,'-') + '.md';
  const path = `${folder}/${filename}`;
  const sha = contentInput.dataset.sha || undefined;

  const body = { 
    message: `${sha ? 'Update' : 'Add'} post: ${capitalizeWords(title)}`, 
    content: btoa(unescape(encodeURIComponent(content)))
  };
  if (sha) body.sha = sha;

  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const result = await res.json();
    if (res.ok) {
      statusDiv.textContent = `✅ Post saved: ${capitalizeWords(title)}`;
      contentInput.dataset.sha = result.content.sha;
      populateFiles(); // refresh file list
    } else {
      statusDiv.textContent = `❌ Error: ${result.message}`;
    }
  } catch (err) {
    statusDiv.textContent = `❌ Error: ${err.message}`;
  }
});

// Initial populate
populateFiles();
</script>
</body>
</html>
